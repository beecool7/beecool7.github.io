<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,">










<meta name="description" content="从Activity创建到布局文件被绘制前从Activity创建说起基础理论​        在了解Activity的被创建前，我们需要知道一个Activity视图的构成。如上图所示，Activity视图构成包括最外层的Activity，Activity内部有一Window成员，其实例为PhoneWindow；PhoneWindow有一内部类DecorView，DecorView可以理解为整个页面的">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="View绘制(一)—从Activity启动到布局文件绘制前">
<meta property="og:url" content="http://yoursite.com/2019/05/07/View绘制（一）-从Activity启动到布局文件绘制前/index.html">
<meta property="og:site_name" content="Beecool7&#39;s Blog">
<meta property="og:description" content="从Activity创建到布局文件被绘制前从Activity创建说起基础理论​        在了解Activity的被创建前，我们需要知道一个Activity视图的构成。如上图所示，Activity视图构成包括最外层的Activity，Activity内部有一Window成员，其实例为PhoneWindow；PhoneWindow有一内部类DecorView，DecorView可以理解为整个页面的">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-05-16T09:43:55.195Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="View绘制(一)—从Activity启动到布局文件绘制前">
<meta name="twitter:description" content="从Activity创建到布局文件被绘制前从Activity创建说起基础理论​        在了解Activity的被创建前，我们需要知道一个Activity视图的构成。如上图所示，Activity视图构成包括最外层的Activity，Activity内部有一Window成员，其实例为PhoneWindow；PhoneWindow有一内部类DecorView，DecorView可以理解为整个页面的">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/05/07/View绘制（一）-从Activity启动到布局文件绘制前/">





  <title>View绘制(一)—从Activity启动到布局文件绘制前 | Beecool7's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Beecool7's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/07/View绘制（一）-从Activity启动到布局文件绘制前/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Beecool7">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Beecool7's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">View绘制(一)—从Activity启动到布局文件绘制前</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-07T14:13:31+08:00">
                2019-05-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="从Activity创建到布局文件被绘制前"><a href="#从Activity创建到布局文件被绘制前" class="headerlink" title="从Activity创建到布局文件被绘制前"></a>从Activity创建到布局文件被绘制前</h1><h2 id="从Activity创建说起"><a href="#从Activity创建说起" class="headerlink" title="从Activity创建说起"></a>从Activity创建说起</h2><h3 id="基础理论"><a href="#基础理论" class="headerlink" title="基础理论"></a>基础理论</h3><p>​        在了解Activity的被创建前，我们需要知道一个Activity视图的构成。如上图所示，Activity视图构成包括最外层的Activity，Activity内部有一Window成员，其实例为PhoneWindow；PhoneWindow有一内部类DecorView，DecorView可以理解为整个页面的根View，而我们写的布局通过setContenView()加入到DecorView中id为content的View中，成为它的一个子View。</p>
<p>​        通常我们是通过starActivity()来启动一个Activity的。从调用starActivity()到一个Activity被创建前，需要经过一段非常复杂的方法调用，最终会在ActivityThread#handleLaunchActivity方法中开始创建Activity(感兴趣的可以看下Activity启动的过程，这里只对Activiy被创建的过程中为布局的绘制做了那些前期准备)。在handleLaunchActivity()中会调用performLaunchActivity()创建一个Activity，那么我们就从performLaunchActivity()开始看看如何创建一个Activity以及其为布局绘制做了那些准备。</p>
<h3 id="2-1ActivityThread-handleLaunchActivity"><a href="#2-1ActivityThread-handleLaunchActivity" class="headerlink" title="2.1ActivityThread.handleLaunchActivity"></a>2.1ActivityThread.handleLaunchActivity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Activity handleLaunchActivity(ActivityClientRecord r,</span><br><span class="line">        PendingTransactionActions pendingActions, Intent customIntent) &#123;</span><br><span class="line">...代码省略</span><br><span class="line">//在分析mWindowSession.addToDisplay将会用到</span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line">    final Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">...代码省略</span><br><span class="line">    return a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####2.1.1ActivityThread.performLaunchActivity</p>
<pre><code>private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) {
            ...代码省略
    Activity activity = null;
    try {
            //通过反射创建Activity
        java.lang.ClassLoader cl = appContext.getClassLoader();
        activity = mInstrumentation.newActivity(
                cl, component.getClassName(), r.intent);
        StrictMode.incrementExpectedActivityCount(activity.getClass());
        r.intent.setExtrasClassLoader(cl);
        r.intent.prepareToEnterProcess();
        if (r.state != null) {
            r.state.setClassLoader(cl);
        }
    } catch (Exception e) {
        if (!mInstrumentation.onException(activity, e)) {
            throw new RuntimeException(
                &quot;Unable to instantiate activity &quot; + component
                + &quot;: &quot; + e.toString(), e);
        }
    }

    try {
                            ...代码省略

                            //activity绑定环境
            activity.attach(appContext, this, getInstrumentation(), r.token,
                    r.ident, app, r.intent, r.activityInfo, title, r.parent,
                    r.embeddedID, r.lastNonConfigurationInstances, config,
                    r.referrer, r.voiceInteractor, window, r.configCallback);

            if (customIntent != null) {
                activity.mIntent = customIntent;
            }
            r.lastNonConfigurationInstances = null;
            checkAndBlockForNetworkAccess();
            activity.mStartedActivity = false;
            int theme = r.activityInfo.getThemeResource();
            if (theme != 0) {
                activity.setTheme(theme);
            }

            activity.mCalled = false;
            //通Instrumentation代理类调用Activity.onCreate
            if (r.isPersistable()) {
                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);
            } else {
                mInstrumentation.callActivityOnCreate(activity, r.state);
            }
            if (!activity.mCalled) {
                throw new SuperNotCalledException(
                    &quot;Activity &quot; + r.intent.getComponent().toShortString() +
                    &quot; did not call through to super.onCreate()&quot;);
            }
            r.activity = activity;
        }
        r.setState(ON_CREATE);

        mActivities.put(r.token, r);

    } catch (SuperNotCalledException e) {
        throw e;

    } catch (Exception e) {
        if (!mInstrumentation.onException(activity, e)) {
            throw new RuntimeException(
                &quot;Unable to start activity &quot; + component
                + &quot;: &quot; + e.toString(), e);
        }
    }

    return activity;
}
</code></pre><p>####2.1.1Activity.attach</p>
<p>[Activity.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">final void attach(Context context, ActivityThread aThread,</span><br><span class="line">        Instrumentation instr, IBinder token, int ident,</span><br><span class="line">        Application application, Intent intent, ActivityInfo info,</span><br><span class="line">        CharSequence title, Activity parent, String id,</span><br><span class="line">        NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="line">        Window window, ActivityConfigCallback activityConfigCallback) &#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">    mFragments.attachHost(null /*parent*/);</span><br><span class="line">		//创建一个PhoneWindow对象 </span><br><span class="line">		//传递进来的window参数为空，根据其构造方法，PhoneWindow对象的DecorView为空</span><br><span class="line">    mWindow = new PhoneWindow(this, window, activityConfigCallback);</span><br><span class="line">    //设置一些监听</span><br><span class="line">    mWindow.setWindowControllerCallback(this);</span><br><span class="line">    mWindow.setCallback(this);</span><br><span class="line">    mWindow.setOnWindowDismissedCallback(this);</span><br><span class="line">    mWindow.getLayoutInflater().setPrivateFactory(this);</span><br><span class="line">    if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">        mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">    &#125;</span><br><span class="line">    if (info.uiOptions != 0) &#123;</span><br><span class="line">        mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">    &#125;</span><br><span class="line">		// ...代码省略 对activity的成员变量的赋值</span><br><span class="line">		// 设置Window管理器 后面会分析它的作用</span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);</span><br><span class="line">    if (mParent != null) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line"></span><br><span class="line">    mWindow.setColorMode(info.colorMode);</span><br><span class="line"></span><br><span class="line">    setAutofillCompatibilityEnabled(application.isAutofillCompatibilityEnabled());</span><br><span class="line">    enableAutofillCompatibilityIfNeeded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2Activity-onCreate"><a href="#2-1-2Activity-onCreate" class="headerlink" title="2.1.2Activity.onCreate"></a>2.1.2Activity.onCreate</h4><p>[Instrumentation.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//通过Instrumentation类中的callActivityOnCreate调用OnCreate</span><br><span class="line">public void callActivityOnCreate(Activity activity, Bundle icicle,</span><br><span class="line">       PersistableBundle persistentState) &#123;</span><br><span class="line">       //执行Create之前会往消息队列中添加一个IdleHandler</span><br><span class="line">       prePerformCreate(activity);</span><br><span class="line">       //执行create,最终会调用onCreate()</span><br><span class="line">       activity.performCreate(icicle, persistentState);</span><br><span class="line">       //执行Create之后会将activity与ActivityMonitor（监听器）进行关联</span><br><span class="line">       postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码最终会调用到我们重写onCreate()，而我们在重写的onCreate()中通过setContentView()来设置我们的布局。setContentView()最终会执行到AppCompatDelegateImplV9#setContentView()。代码如下：</p>
<p>####2.1.3AppCompatDelegateImplV9.setContentView</p>
<p>[AppCompatDelegateImplV9.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void setContentView(int resId) &#123;</span><br><span class="line">		//创建子DecorView</span><br><span class="line">    ensureSubDecor();</span><br><span class="line">    //移除subDecor中id为content的ViewGruop的所有子view，将我们的布局添加进去</span><br><span class="line">    ViewGroup contentParent = (ViewGroup) mSubDecor.findViewById(android.R.id.content);</span><br><span class="line">    contentParent.removeAllViews();</span><br><span class="line">    LayoutInflater.from(mContext).inflate(resId, contentParent);</span><br><span class="line">    //通常窗口布局发生变化</span><br><span class="line">    mOriginalWindowCallback.onContentChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####2.1.4AppCompatDelegateImplV9.ensureSubDecor</p>
<p>[AppCompatDelegateImplV9.java]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void ensureSubDecor() &#123;</span><br><span class="line">    if (!mSubDecorInstalled) &#123;</span><br><span class="line">    		//创建subDecor</span><br><span class="line">        mSubDecor = createSubDecor();</span><br><span class="line">       // ...代码省略</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> * ensureSubDecor()核心是createSubDecor()</span><br><span class="line"> * createSubDecor()代码很长，我们关心的是DecorView和subDecor是如何被创建的，它们之间的存在怎么的关联</span><br><span class="line"> */</span><br><span class="line">private ViewGroup createSubDecor() &#123;</span><br><span class="line">		// ...代码省略 (widow的初始化属性)</span><br><span class="line"></span><br><span class="line">    // Now let&apos;s make sure that the Window has installed its decor by retrieving it</span><br><span class="line">    // 检索window是否装载了DecorView(非常重要) </span><br><span class="line">    mWindow.getDecorView();</span><br><span class="line">		</span><br><span class="line">		// ...代码省略 (主要描述如何通过设置加载不同的subDecor的布局)</span><br><span class="line">		</span><br><span class="line">    // Make the decor optionally fit system windows, like the window&apos;s decor</span><br><span class="line">    ViewUtils.makeOptionalFitsSystemWindows(subDecor);</span><br><span class="line">		// contentView将是最终添加我们的布局的父View</span><br><span class="line">    final ContentFrameLayout contentView = (ContentFrameLayout) subDecor.findViewById(</span><br><span class="line">            R.id.action_bar_activity_content);</span><br><span class="line"></span><br><span class="line">    final ViewGroup windowContentView = (ViewGroup) 			 mWindow.findViewById(android.R.id.content);</span><br><span class="line">    if (windowContentView != null) &#123;</span><br><span class="line">        // There might be Views already added to the Window&apos;s content view so we need to</span><br><span class="line">        // migrate them to our content view</span><br><span class="line">        // 清空DecorView中id为content的ViewGroup的所有子view，并将这些子view添加到subDecor的contentView中</span><br><span class="line">        while (windowContentView.getChildCount() &gt; 0) &#123;</span><br><span class="line">            final View child = windowContentView.getChildAt(0);</span><br><span class="line">            windowContentView.removeViewAt(0);</span><br><span class="line">            contentView.addView(child);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Change our content FrameLayout to use the android.R.id.content id.</span><br><span class="line">        // Useful for fragments.</span><br><span class="line">        // 清空DecorView中windowContentView的id</span><br><span class="line">        windowContentView.setId(View.NO_ID);</span><br><span class="line">        // 将subDecor中的contentView的id设置为content，最终替换了DecorView的contentView</span><br><span class="line">        contentView.setId(android.R.id.content);</span><br><span class="line"></span><br><span class="line">        // The decorContent may have a foreground drawable set (windowContentOverlay).</span><br><span class="line">        // Remove this as we handle it ourselves</span><br><span class="line">        if (windowContentView instanceof FrameLayout) &#123;</span><br><span class="line">            ((FrameLayout) windowContentView).setForeground(null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Now set the Window&apos;s content view with the decor</span><br><span class="line">    // 将subDecor 填充到DecorView中</span><br><span class="line">    mWindow.setContentView(subDecor);</span><br><span class="line">		// ...代码省略</span><br><span class="line">    return subDecor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码，我们了解到subDecor先通过不同的设置加载得到不同的布局，然后subDecor中的contentView替换掉DecorView中windowContentView，接着subDecor被添加到DecorView中，最后替代DecorView来完成填充我们自己的写的布局。但是上面还有很重要的内容没分析—DecorView是如何被创建的。接下来我们走一遍mWindow.getDecorView()的源码</p>
<p>####2.1.5PhoneWindow.installDecor()</p>
<p>[PhoneWindow.java]</p>
<p>getDecorView中调用了installDecor方法，在该方法中我们只需要找到mDecor = generateDecor(-1)和 mContentParent = generateLayout(mDecor)这两行代码，一个是初始化DecorView，一个是初始化mContentParent。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected DecorView generateDecor(int featureId) &#123;</span><br><span class="line">    Context context;</span><br><span class="line">    if (mUseDecorContext) &#123;</span><br><span class="line">        Context applicationContext = getContext().getApplicationContext();</span><br><span class="line">        if (applicationContext == null) &#123;</span><br><span class="line">            context = getContext();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            context = new DecorContext(applicationContext, getContext());</span><br><span class="line">            if (mTheme != -1) &#123;</span><br><span class="line">                context.setTheme(mTheme);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        context = getContext();</span><br><span class="line">    &#125;</span><br><span class="line">    return new DecorView(context, featureId, this, getAttributes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>generateDecor代码很简单，创建了一个DecorView对象，DecorView继承了FrameLayout，是我们要显示布局的顶级View，其包括界面顶部标题栏。接下来看下generateLayout有干了那些事情。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">protected ViewGroup generateLayout(DecorView decor) &#123;</span><br><span class="line">    // Apply data from current theme.</span><br><span class="line"></span><br><span class="line">    TypedArray a = getWindowStyle();</span><br><span class="line"></span><br><span class="line">    if (false) &#123;</span><br><span class="line">        System.out.println(&quot;From style:&quot;);</span><br><span class="line">        String s = &quot;Attrs:&quot;;</span><br><span class="line">        for (int i = 0; i &lt; R.styleable.Window.length; i++) &#123;</span><br><span class="line">            s = s + &quot; &quot; + Integer.toHexString(R.styleable.Window[i]) + &quot;=&quot;</span><br><span class="line">                    + a.getString(i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, false);</span><br><span class="line">    int flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR)</span><br><span class="line">            &amp; (~getForcedWindowFlags());</span><br><span class="line">    if (mIsFloating) &#123;</span><br><span class="line">        setLayout(WRAP_CONTENT, WRAP_CONTENT);</span><br><span class="line">        setFlags(0, flagsToUpdate);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        setFlags(FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR, flagsToUpdate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ....  代码省略 (主要解析主题的一些设置,比如ActionBar、透明度、全屏、状态栏、背景、阴影等等)</span><br><span class="line">    </span><br><span class="line">    // Inflate the window decor.</span><br><span class="line">		// 这里开始，会根据前面设置的特性来选择对应的根布局文件</span><br><span class="line">    int layoutResource;</span><br><span class="line">    int features = getLocalFeatures();</span><br><span class="line">    // System.out.println(&quot;Features: 0x&quot; + Integer.toHexString(features));</span><br><span class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</span><br><span class="line">    		//如果在setContenView之前设置了FEATURE_SWIPE_TO_DISMISS，将进入到这里，实现右滑退出功能</span><br><span class="line">        layoutResource = R.layout.screen_swipe_dismiss;</span><br><span class="line">        setCloseOnSwipeEnabled(true);</span><br><span class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_LEFT_ICON) | (1 &lt;&lt; FEATURE_RIGHT_ICON))) != 0)&#123;				 //设置带图标标题的布局</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = new TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogTitleIconsDecorLayout, res, true);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            layoutResource = R.layout.screen_title_icons;</span><br><span class="line">        &#125;</span><br><span class="line">        // XXX Remove this once action bar supports these features.</span><br><span class="line">        // 这种特性下，需要移除ActionBar</span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">        // System.out.println(&quot;Title Icons!&quot;);</span><br><span class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_PROGRESS) | (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != 0</span><br><span class="line">            &amp;&amp; (features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) == 0) &#123;</span><br><span class="line">        // Special case for a window with only a progress bar (and title).</span><br><span class="line">        // XXX Need to have a no-title version of embedded windows.</span><br><span class="line">        // 带进度条的布局</span><br><span class="line">        layoutResource = R.layout.screen_progress;</span><br><span class="line">        // System.out.println(&quot;Progress!&quot;);</span><br><span class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_CUSTOM_TITLE)) != 0) &#123;</span><br><span class="line">        // Special case for a window with a custom title.</span><br><span class="line">        // If the window is floating, we need a dialog layout</span><br><span class="line">        // 设置可自定义标题的布局</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = new TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogCustomTitleDecorLayout, res, true);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            layoutResource = R.layout.screen_custom_title;</span><br><span class="line">        &#125;</span><br><span class="line">        // XXX Remove this once action bar supports these features.</span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) == 0) &#123;</span><br><span class="line">        // If no other features and not embedded, only need a title.</span><br><span class="line">        // If the window is floating, we need a dialog layout</span><br><span class="line">        // 不带标题的布局</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = new TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogTitleDecorLayout, res, true);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) != 0) &#123;</span><br><span class="line">            layoutResource = a.getResourceId(</span><br><span class="line">            //带ActionBar的布局</span><br><span class="line">                    R.styleable.Window_windowActionBarFullscreenDecorLayout,</span><br><span class="line">                    R.layout.screen_action_bar);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            layoutResource = R.layout.screen_title;</span><br><span class="line">        &#125;</span><br><span class="line">        // System.out.println(&quot;Title!&quot;);</span><br><span class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != 0) &#123;</span><br><span class="line">    		//ActionBar悬浮布局</span><br><span class="line">        layoutResource = R.layout.screen_simple_overlay_action_mode;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Embedded, so no decoration is needed.</span><br><span class="line">        //  一般我们都是填充了这个布局</span><br><span class="line">        layoutResource = R.layout.screen_simple;</span><br><span class="line">        // System.out.println(&quot;Simple!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDecor.startChanging();</span><br><span class="line">    // 通过addView()将布局添加到DecorView中</span><br><span class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line">		// 获取id为content的内容View</span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">    if (contentParent == null) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Window couldn&apos;t find content container view&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != 0) &#123;</span><br><span class="line">        ProgressBar progress = getCircularProgressBar(false);</span><br><span class="line">        if (progress != null) &#123;</span><br><span class="line">            progress.setIndeterminate(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</span><br><span class="line">        registerSwipeCallbacks(contentParent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Remaining setup -- of background and title -- that only applies</span><br><span class="line">    // to top-level windows.</span><br><span class="line">    // 为DecorView设置背景、标题、阴影</span><br><span class="line">    if (getContainer() == null) &#123;</span><br><span class="line">        final Drawable background;</span><br><span class="line">        if (mBackgroundResource != 0) &#123;</span><br><span class="line">            background = getContext().getDrawable(mBackgroundResource);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            background = mBackgroundDrawable;</span><br><span class="line">        &#125;</span><br><span class="line">        mDecor.setWindowBackground(background);</span><br><span class="line"></span><br><span class="line">        final Drawable frame;</span><br><span class="line">        if (mFrameResource != 0) &#123;</span><br><span class="line">            frame = getContext().getDrawable(mFrameResource);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            frame = null;</span><br><span class="line">        &#125;</span><br><span class="line">        mDecor.setWindowFrame(frame);</span><br><span class="line"></span><br><span class="line">        mDecor.setElevation(mElevation);</span><br><span class="line">        // 是否应该将窗口内容剪切到背景中</span><br><span class="line">        mDecor.setClipToOutline(mClipToOutline);</span><br><span class="line"></span><br><span class="line">        if (mTitle != null) &#123;</span><br><span class="line">            setTitle(mTitle);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (mTitleColor == 0) &#123;</span><br><span class="line">            mTitleColor = mTextColor;</span><br><span class="line">        &#125;</span><br><span class="line">        setTitleColor(mTitleColor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDecor.finishChanging();</span><br><span class="line">		// 最终返回内容布局</span><br><span class="line">    return contentParent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>generateLayout的代码很长，可以分三个部分。第一部分是上述代码中省略的部分，主要解析主题的一些设置,比如ActionBar、透明度、全屏、状态栏、背景、阴影等等。需要注意的是，平时我们在使用requestWindowFeature()来设置窗口属性时，需要写在setContentView之前，否则设置将无效，因为在setContentView执行时已经读取了本地的features；第二部分是根据解析得到的布局特性，来选择不同的布局文件，通常情况下我们最终填充的布局文件将会是screen_simple布局。(mac下：/Users/{自己的用户名}/Library/Android/sdk/platforms/{不同版本的Android}/data/res/layout  在layout文件夹中查看布局文件)。第三部分：填充选择后的布局，并且为DecorView设置一些属性，最终返回内容布局。</p>
<h3 id="3-1ActivityThread-handleResumeActivity"><a href="#3-1ActivityThread-handleResumeActivity" class="headerlink" title="3.1ActivityThread.handleResumeActivity"></a>3.1ActivityThread.handleResumeActivity</h3><p>在AMS调用完ActivityThread.handleLaunchActivity后走完onCreate生命周期接下来就是调用handleResumeActivity，走onResume生命周期后，Activity、window、decorview都已被创建。那它们之间的联系需要我们一起分析下handleResumeActivity的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">        String reason) &#123;</span><br><span class="line">    // If we are getting ready to gc after going to the background, well</span><br><span class="line">    // we are back active so skip it.</span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line">    mSomeActivitiesChanged = true;</span><br><span class="line"></span><br><span class="line">    // TODO Push resumeArgs into the activity for consideration</span><br><span class="line">    // 这里调用Activity的onResume（）  但是过程是先从Activity集合中通过token获取到一个ActivityClientRecord 对象，然后调用该对象里面的Activity类型的参数，使之进入onResume,此时的ActivityClientRecord 还没有window对象（下面会用到）</span><br><span class="line">    final ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">    if (r == null) &#123;</span><br><span class="line">        // We didn&apos;t actually resume the activity, so skipping any follow-up actions.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    final Activity a = r.activity;</span><br><span class="line">		</span><br><span class="line">    if (localLOGV) &#123;</span><br><span class="line">        Slog.v(TAG, &quot;Resume &quot; + r + &quot; started activity: &quot; + a.mStartedActivity</span><br><span class="line">                + &quot;, hideForNow: &quot; + r.hideForNow + &quot;, finished: &quot; + a.mFinished);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final int forwardBit = isForward</span><br><span class="line">            ? WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : 0;</span><br><span class="line"></span><br><span class="line">    // If the window hasn&apos;t yet been added to the window manager,</span><br><span class="line">    // and this guy didn&apos;t finish itself or start another activity,</span><br><span class="line">    // then go ahead and add the window.</span><br><span class="line">    boolean willBeVisible = !a.mStartedActivity;</span><br><span class="line">    if (!willBeVisible) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            willBeVisible = ActivityManager.getService().willActivityBeVisible(</span><br><span class="line">                    a.getActivityToken());</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            throw e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 上面说了 r.window == null</span><br><span class="line">    if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">    		// window和decorView都已经被创建</span><br><span class="line">        r.window = r.activity.getWindow();</span><br><span class="line">        View decor = r.window.getDecorView();</span><br><span class="line">        decor.setVisibility(View.INVISIBLE);</span><br><span class="line">        // 在执行activity.attach方法后，已获取到了wm</span><br><span class="line">        ViewManager wm = a.getWindowManager();</span><br><span class="line">        //这段需要注意，在布局测绘的时候会被用到。窗口的布局参数</span><br><span class="line">        WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">        a.mDecor = decor;</span><br><span class="line">        l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">        l.softInputMode |= forwardBit;</span><br><span class="line">        // r是否保存了window</span><br><span class="line">        if (r.mPreserveWindow) &#123;</span><br><span class="line">            a.mWindowAdded = true;</span><br><span class="line">            r.mPreserveWindow = false;</span><br><span class="line">            // Normally the ViewRoot sets up callbacks with the Activity</span><br><span class="line">            // in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span><br><span class="line">            // the decor view we have to notify the view root that the</span><br><span class="line">            // callbacks may have changed.</span><br><span class="line">            ViewRootImpl impl = decor.getViewRootImpl();</span><br><span class="line">            if (impl != null) &#123;</span><br><span class="line">                impl.notifyChildRebuilt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // activity是否准备显示</span><br><span class="line">        if (a.mVisibleFromClient) &#123;</span><br><span class="line">        		// mWindowAdded默认为false</span><br><span class="line">            if (!a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = true;</span><br><span class="line">                // 将ViewManager与deocorView进行关联</span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // The activity will get a callback for this &#123;@link LayoutParams&#125; change</span><br><span class="line">                // earlier. However, at that time the decor will not be set (this is set</span><br><span class="line">                // in this method), so no action will be taken. This call ensures the</span><br><span class="line">                // callback occurs with the decor set.</span><br><span class="line">                a.onWindowAttributesChanged(l);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // If the window has already been added, but during resume</span><br><span class="line">        // we started another activity, then don&apos;t yet make the</span><br><span class="line">        // window visible.</span><br><span class="line">    &#125; else if (!willBeVisible) &#123;</span><br><span class="line">        if (localLOGV) Slog.v(TAG, &quot;Launch &quot; + r + &quot; mStartedActivity set&quot;);</span><br><span class="line">        r.hideForNow = true;</span><br><span class="line">    &#125;</span><br><span class="line">// ....代码省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2Window-setWindowManager"><a href="#3-2Window-setWindowManager" class="headerlink" title="3.2Window.setWindowManager"></a>3.2Window.setWindowManager</h3><p>在handleResumeActivity()代码中，先调用performResumeActivity()获取一个ActivityClientRecord（用于记录真实activity实例）对象，并且会调用activity的onResume()，此时布局还没有开始进行测绘，界面还没有展示出来。然后会通过wm.addView将WindowManager与DeocorView进行关联。分析addView()，看看它们是如何进行关联的？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface ViewManager</span><br><span class="line">&#123;</span><br><span class="line">    public void addView(View view, ViewGroup.LayoutParams params);</span><br><span class="line">    public void updateViewLayout(View view, ViewGroup.LayoutParams params);</span><br><span class="line">    public void removeView(View view);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WindowManager是一个接口类，继承自ViewManager，ViewManager代码如上，我们需要找到WindowManager的实现类，也就是WindowManagerImpl。而WindowManagerImpl对象是在Activity执行attach()时被创建，在attach方法中，创建了PhoneWindow对象，调用PhoneWindow.setWindowManager，而setWindowManager具体实现是在Window类中，代码中调用createLocalWindowManager创建一个WindowManagerImpl对象，其实它相当于一个代理类，它的内部是通过WindowManagerGlobal这个单例来管理的。所以上述代码中vm.addView最总调用的是WindowManagerGlobal.addView。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public void addView(View view, ViewGroup.LayoutParams params,</span><br><span class="line">        Display display, Window parentWindow) &#123;</span><br><span class="line">    if (view == null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;view must not be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (display == null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;display must not be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!(params instanceof WindowManager.LayoutParams)) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;Params must be WindowManager.LayoutParams&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</span><br><span class="line">    if (parentWindow != null) &#123;</span><br><span class="line">        parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // If there&apos;s no parent, then hardware acceleration for this view is</span><br><span class="line">        // set from the application&apos;s hardware acceleration setting.</span><br><span class="line">        final Context context = view.getContext();</span><br><span class="line">        if (context != null</span><br><span class="line">                &amp;&amp; (context.getApplicationInfo().flags</span><br><span class="line">                        &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) &#123;</span><br><span class="line">            wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		//ViewRootImpl是关键</span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = null;</span><br><span class="line"></span><br><span class="line">    // ...代码省略</span><br><span class="line">    </span><br><span class="line">				//创建ViewRootImpl对象</span><br><span class="line">        root = new ViewRootImpl(view.getContext(), display);</span><br><span class="line">				//wparams是默认window的布局参数，将作为DecorView布局参数</span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">				//mViews管理的所有DecorView</span><br><span class="line">        mViews.add(view);</span><br><span class="line">        //mRoots管理DecorView所对应的ViewRootImpl</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        //mParams管理的DecorView所对应的LayoutParams</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">        // do this last because it fires off messages to start doing things</span><br><span class="line">        try &#123;</span><br><span class="line">        		// 最后调用ViewRootImpl的setView()</span><br><span class="line">            root.setView(view, wparams, panelParentView);</span><br><span class="line">        &#125; catch (RuntimeException e) &#123;</span><br><span class="line">            // BadTokenException or InvalidDisplayException, clean up.</span><br><span class="line">            if (index &gt;= 0) &#123;</span><br><span class="line">                removeViewLocked(index, true);</span><br><span class="line">            &#125;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * We have one child</span><br><span class="line"> */</span><br><span class="line">public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        if (mView == null) &#123;</span><br><span class="line">            mView = view;</span><br><span class="line">				// ...代码省略</span><br><span class="line">            mAdded = true;</span><br><span class="line">            int res; /* = WindowManagerImpl.ADD_OKAY; */</span><br><span class="line"></span><br><span class="line">            // Schedule the first layout -before- adding to the window</span><br><span class="line">            // manager, to make sure we do the relayout before receiving</span><br><span class="line">            // any other events from the system.</span><br><span class="line">            // DecorView的测绘将在此方法中进行</span><br><span class="line">            requestLayout();</span><br><span class="line">            if ((mWindowAttributes.inputFeatures</span><br><span class="line">                    &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) &#123;</span><br><span class="line">                mInputChannel = new InputChannel();</span><br><span class="line">            &#125;</span><br><span class="line">            mForceDecorViewVisibility = (mWindowAttributes.privateFlags</span><br><span class="line">                    &amp; PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != 0;</span><br><span class="line">            try &#123;</span><br><span class="line">                mOrigWindowType = mWindowAttributes.type;</span><br><span class="line">                mAttachInfo.mRecomputeGlobalAttributes = true;</span><br><span class="line">                collectViewAttributes();</span><br><span class="line">                // 如何将当前窗口展示出来</span><br><span class="line">                res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                        getHostVisibility(), mDisplay.getDisplayId(), mWinFrame,</span><br><span class="line">                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                        mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel);</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                mAdded = false;</span><br><span class="line">                mView = null;</span><br><span class="line">                mAttachInfo.mRootView = null;</span><br><span class="line">                mInputChannel = null;</span><br><span class="line">                mFallbackEventHandler.setView(null);</span><br><span class="line">                unscheduleTraversals();</span><br><span class="line">                setAccessibilityFocus(null, null);</span><br><span class="line">                throw new RuntimeException(&quot;Adding window failed&quot;, e);</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                if (restore) &#123;</span><br><span class="line">                    attrs.restore();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">		// ...代码省略</span><br><span class="line">						//将ViewRootImpl设置为DecorView父view，</span><br><span class="line">            view.assignParent(this);</span><br><span class="line">		// ...代码省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的分析我们可以知道：Activity的PhoneWindow通过setWindowManager，得到一个WindowManagerImpl对象，并通过该对象管理它自己。WindowManagerImpl相当于WindowManagerGlobal的代理类，调用addView后为DecorView创建一个ViewRootImpl对象，然后将DecorView，ViewRootImpl，DecorView所对应的LayoutParams分别保存在WindowManagerGlobal的数组mViews、mRoots、mParams中。最后通过ViewRootImpl.setView，对DecorView进行测绘及展示，并将该ViewRootImpl设置为DecorView的父类，之后对布局的一些操作将通过ViewRootImpl来实现。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/06/博客时间/" rel="next" title="博客时间">
                <i class="fa fa-chevron-left"></i> 博客时间
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Beecool7</p>
              <p class="site-description motion-element" itemprop="description">大圣此去欲何，踏南天碎凌霄，若一去不回，便一去不回！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#从Activity创建到布局文件被绘制前"><span class="nav-number">1.</span> <span class="nav-text">从Activity创建到布局文件被绘制前</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#从Activity创建说起"><span class="nav-number">1.1.</span> <span class="nav-text">从Activity创建说起</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础理论"><span class="nav-number">1.1.1.</span> <span class="nav-text">基础理论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1ActivityThread-handleLaunchActivity"><span class="nav-number">1.1.2.</span> <span class="nav-text">2.1ActivityThread.handleLaunchActivity</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2Activity-onCreate"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">2.1.2Activity.onCreate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1ActivityThread-handleResumeActivity"><span class="nav-number">1.1.3.</span> <span class="nav-text">3.1ActivityThread.handleResumeActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2Window-setWindowManager"><span class="nav-number">1.1.4.</span> <span class="nav-text">3.2Window.setWindowManager</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Beecool7</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
